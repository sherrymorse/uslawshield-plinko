<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>U.S. LawShield Plinko</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Anton&family=Oswald:wght@400;700&family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Oswald', sans-serif;
      background: linear-gradient(135deg, #0e1d61 0%, #1a2a7a 100%);
      padding: 20px;
      min-height: 100vh;
      color: white;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 30px 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
    }
    .main-title {
      font-family: 'Anton', sans-serif;
      font-size: 3.8em;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 3px;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
    }
    .subtitle {
      font-size: 1.4em;
      font-weight: 700;
      color: #0e1d61;
      background: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: inline-block;
      margin: 15px 0;
    }
    .tagline {
      font-size: 1.1em;
      font-weight: 700;
      color: #e7d386;
      letter-spacing: 2px;
      margin-top: 10px;
    }
    .player-info {
      text-align: center;
      font-size: 1.2em;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(231, 211, 134, 0.2);
      border-radius: 10px;
      font-weight: 600;
    }
    .controls { text-align: center; margin-bottom: 30px; }
    button {
      font-family: 'Oswald', sans-serif;
      font-size: 1em;
      font-weight: 700;
      padding: 12px 30px;
      margin: 0 10px 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      text-transform: uppercase;
    }
    .btn-primary {
      background: linear-gradient(135deg, #d51e47 0%, #b01838 100%);
      color: white;
    }
    .btn-secondary {
      background: white;
      color: #0e1d61;
      border: 2px solid #0e1d61;
    }
    .game-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .plinko-board {
      background: linear-gradient(180deg, #1a2a7a 0%, #0e1d61 100%);
      border: 4px solid #e7d386;
      border-radius: 15px;
      padding: 20px;
    }
    #plinkoCanvas {
      display: block;
      background: #ffffff;
      border-radius: 10px;
      cursor: grab;
    }
    .disc-sidebar {
      background: rgba(255, 255, 255, 0.98);
      border: 3px solid #0e1d61;
      border-radius: 10px;
      padding: 15px;
      width: 300px;
      max-height: 600px;
      overflow-y: auto;
      color: #333;
    }
    .disc-sidebar h4 {
      color: #d51e47;
      margin-bottom: 10px;
    }
    .disc-item {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      border-left: 4px solid #d51e47;
      cursor: pointer;
      margin-bottom: 10px;
      transition: all 0.2s;
      color: #333;
      user-select: none;
    }
    .disc-item:hover { 
      transform: scale(1.03); 
      background: #e9ecef;
    }
    .disc-item.selected { 
      opacity: 0.5; 
      transform: scale(1.05);
      background: #dee2e6;
    }
    .instructions {
      font-size: 0.85em;
      color: #e7d386;
      text-align: center;
      margin-bottom: 15px;
      padding: 5px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }
    .total-score {
      text-align: center;
      font-size: 1.5em;
      margin-top: 20px;
      color: #e7d386;
      font-weight: 700;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 30px;
      border: 4px solid #0e1d61;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
    }
    .modal-title {
      font-family: 'Anton', sans-serif;
      font-size: 1.8em;
      color: #0e1d61;
      text-align: center;
      margin-bottom: 10px;
    }
    .modal-body label {
      display: block;
      font-weight: 700;
      color: #0e1d61;
      margin: 15px 0 8px;
    }
    .modal-body input, .modal-body select {
      width: 100%;
      padding: 12px;
      font-size: 1.1em;
      border: 2px solid #0e1d61;
      border-radius: 8px;
    }
    .error-message {
      color: #d51e47;
      font-size: 0.9em;
      margin-top: 8px;
      display: none;
      font-weight: 600;
    }
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    @media (max-width: 768px) {
      .game-container { flex-direction: column; }
      .disc-sidebar { width: 100%; max-height: 300px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1 class="main-title">U.S. LAWSHIELD</h1>
    <div class="subtitle">EMPLOYEE ENGAGEMENT PLINKO</div>
    <p class="tagline">LEGAL DEFENSE FOR SELF DEFENSEÂ®</p>
  </div>
  
  <div class="player-info" id="playerInfo" style="display: none;"></div>
  
  <div class="controls">
    <button class="btn-primary" id="earnDiscBtn">Earn Plinko Disc</button>
    <button class="btn-secondary" id="clearProgressBtn">Clear Progress</button>
  </div>
  
  <div class="game-container">
    <div class="plinko-board">
      <canvas id="plinkoCanvas" width="600" height="1000"></canvas>
      <div class="total-score" id="totalScore">Total Winnings: $0</div>
    </div>
    
    <div class="disc-sidebar">
      <div class="instructions">Click a disc, then click on the ramp to drop!</div>
      <h4>Available Discs <span id="availableCount"></span></h4>
      <div id="availableDiscList"></div>
      <button class="btn-primary" id="earnMoreBtn" style="width: 100%; margin-top: 10px;">Earn More Discs</button>
    </div>
  </div>

  <div id="nameModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2 class="modal-title">Welcome to U.S. LawShield Plinko!</h2>
      <p style="color: #666; text-align: center; margin-bottom: 20px;">Please enter your name to get started</p>
      <div class="modal-body">
        <label for="nameInput">Your Name:</label>
        <input type="text" id="nameInput" placeholder="Enter your name">
        <div class="error-message" id="nameError">Please enter your name</div>
      </div>
      <div class="modal-footer">
        <button class="btn-primary" id="submitNameBtn">Start Playing</button>
      </div>
    </div>
  </div>

  <div id="earnDiscModal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title">Earn a Plinko Disc</h2>
      <p style="color: #666; text-align: center; margin-bottom: 20px;">Select an activity and enter a valid Member ID</p>
      <div class="modal-body">
        <label for="activitySelect">Activity:</label>
        <select id="activitySelect">
          <option value="">Select Activity</option>
          <option value="Single PR">Single PR</option>
          <option value="Dual PR">Dual PR</option>
          <option value="Dual Monthly LOC">Dual Monthly LOC</option>
          <option value="Single Monthly LOC">Single Monthly LOC</option>
          <option value="Single Annual LOC">Single Annual LOC</option>
          <option value="Dual Annual LOC">Dual Annual LOC</option>
          <option value="Add Secondary Legacy (Monthly)">Add Secondary Legacy (Monthly)</option>
          <option value="Add Secondary Legacy (Annual)">Add Secondary Legacy (Annual)</option>
          <option value="Conversion to Explore">Conversion to Explore</option>
          <option value="Conversion to Navigate">Conversion to Navigate</option>
          <option value="Conversion to Discover">Conversion to Discover</option>
          <option value="Add E-Shield">Add E-Shield</option>
          <option value="LSLP (monthly)">LSLP (monthly)</option>
          <option value="LSLP (Annual)">LSLP (Annual)</option>
          <option value="Save">Save</option>
          <option value="Winback (monthly)">Winback (monthly)</option>
          <option value="Winback (annual)">Winback (annual)</option>
        </select>
        <label for="memberIdInput">Member ID:</label>
        <input type="text" id="memberIdInput" placeholder="e.g., ABC123456" maxlength="10" style="text-transform: uppercase; font-family: monospace;">
        <div class="error-message" id="errorMessage"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-primary" id="submitDiscBtn">Submit</button>
        <button type="button" class="btn-secondary" id="cancelDiscBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDzNTPcHXIgb7T73yX0ngLyuJkSiyUd3dA",
      authDomain: "uslawshield-bingo.firebaseapp.com",
      databaseURL: "https://uslawshield-bingo-default-rtdb.firebaseio.com",
      projectId: "uslawshield-bingo",
      storageBucket: "uslawshield-bingo.appspot.com",
      messagingSenderId: "227127069053",
      appId: "1:227127069053:web:be6acba57a6561ad9ce414"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let playerId = null;
    let gameState = { discs: [], totalScore: 0, playerName: '' };
    let canvas, ctx;
    const BOARD_WIDTH = 600;
    const BOARD_HEIGHT = 1000;
    const DISC_RADIUS = 20;
    const PEG_RADIUS = 6;
    const NUM_ROWS = 12;
    const NUM_SLOTS = 9;
    const SLOT_VALUES = [100, 500, 1000, 0, 10000, 0, 1000, 500, 100];
    const SLOT_COLORS = ['#22c55e', '#22c55e', '#22c55e', '#ef4444', '#fbbf24', '#ef4444', '#22c55e', '#22c55e', '#22c55e'];
    let pegs = [];
    let currentDisc = null;
    let animationFrameId = null;
    let selectedDiscIndex = -1;
    const DROP_ZONE_Y_MAX = 220;
    const RAMP_HEIGHT = 200;
    const RAMP_SLOPE = -Math.PI / 6;

    function initPlinkoBoard() {
      canvas = document.getElementById('plinkoCanvas');
      ctx = canvas.getContext('2d');
      createPegs();
      drawBoard();
      
      canvas.addEventListener('click', handleCanvasClick);
    }

    function createPegs() {
      const rowSpacing = (BOARD_HEIGHT - RAMP_HEIGHT) / (NUM_ROWS + 1);
      const colSpacing = BOARD_WIDTH / 8;
      for (let row = 0; row < NUM_ROWS; row++) {
        const numCols = row % 2 === 0 ? 9 : 8;
        const offset = row % 2 === 0 ? 0 : colSpacing / 2;
        for (let col = 0; col < numCols; col++) {
          pegs.push({
            x: offset + col * colSpacing,
            y: RAMP_HEIGHT + rowSpacing + row * rowSpacing,
          });
        }
      }
    }

    function drawBoard() {
      ctx.clearRect(0, 0, BOARD_WIDTH, BOARD_HEIGHT);
      
      const rampGradient = ctx.createLinearGradient(0, 0, 0, RAMP_HEIGHT);
      rampGradient.addColorStop(0, '#6b7280');
      rampGradient.addColorStop(0.5, '#4b5563');
      rampGradient.addColorStop(1, '#374151');
      ctx.fillStyle = rampGradient;
      ctx.fillRect(0, 0, BOARD_WIDTH, RAMP_HEIGHT);
      
      ctx.strokeStyle = '#e7d386';
      ctx.lineWidth = 4;
      ctx.strokeRect(2, 2, BOARD_WIDTH - 4, RAMP_HEIGHT - 4);
      
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      for (let i = 20; i < RAMP_HEIGHT; i += 20) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(BOARD_WIDTH, i);
        ctx.stroke();
      }
      
      pegs.forEach(peg => {
        ctx.shadowBlur = 8;
        ctx.shadowColor = '#e7d386';
        ctx.beginPath();
        ctx.arc(peg.x, peg.y, PEG_RADIUS, 0, Math.PI * 2);
        ctx.fillStyle = '#fbbf24';
        ctx.fill();
        ctx.shadowBlur = 0;
        ctx.strokeStyle = '#0e1d61';
        ctx.lineWidth = 2;
        ctx.stroke();
      });
      
      const slotHeight = 50;
      const slotWidth = BOARD_WIDTH / NUM_SLOTS;
      for (let i = 0; i < NUM_SLOTS; i++) {
        ctx.fillStyle = SLOT_COLORS[i];
        ctx.fillRect(i * slotWidth, BOARD_HEIGHT - slotHeight, slotWidth, slotHeight);
        ctx.fillStyle = 'white';
        ctx.font = 'bold 20px Oswald';
        ctx.textAlign = 'center';
        ctx.fillText(`$${SLOT_VALUES[i]}`, i * slotWidth + slotWidth / 2, BOARD_HEIGHT - slotHeight / 2 + 7);
      }
      
      if (currentDisc) {
        drawDisc(currentDisc.x, currentDisc.y);
      }
    }

    function drawDisc(x, y) {
      ctx.beginPath();
      ctx.arc(x, y, DISC_RADIUS, 0, Math.PI * 2);
      ctx.fillStyle = '#d51e47';
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      ctx.beginPath();
      ctx.arc(x - 7, y - 7, DISC_RADIUS / 2, 0, Math.PI);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
      ctx.fill();
      
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, Math.PI * 2);
      ctx.fillStyle = '#e7d386';
      ctx.fill();
    }

    function animateDisc() {
      if (!currentDisc) return;
      
      currentDisc.x += currentDisc.vx;
      currentDisc.y += currentDisc.vy;
      
      if (currentDisc.y < RAMP_HEIGHT) {
        currentDisc.vy += 0.15 * Math.sin(RAMP_SLOPE);
        currentDisc.vx += 0.15 * Math.cos(RAMP_SLOPE);
        currentDisc.vx *= 0.96;
        currentDisc.vy *= 0.96;
      } else {
        currentDisc.vy += 0.15;
        currentDisc.vx *= 0.94;
        currentDisc.vy *= 0.94;
      }
      
      if (currentDisc.x - DISC_RADIUS < 0) {
        currentDisc.x = DISC_RADIUS + 2;
        currentDisc.vx *= -0.95;
        currentDisc.vx += (Math.random() - 0.5) * 1.2;
      } else if (currentDisc.x + DISC_RADIUS > BOARD_WIDTH) {
        currentDisc.x = BOARD_WIDTH - DISC_RADIUS - 2;
        currentDisc.vx *= -0.95;
        currentDisc.vx += (Math.random() - 0.5) * 1.2;
      }
      
      pegs.forEach(peg => {
        const dx = currentDisc.x - peg.x;
        const dy = currentDisc.y - peg.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const minDist = DISC_RADIUS + PEG_RADIUS;
        
        if (dist < minDist) {
          const nx = dx / (dist || 1);
          const ny = dy / (dist || 1);
          const overlap = minDist - dist;
          
          currentDisc.x += nx * overlap;
          currentDisc.y += ny * overlap;
          
          const dot = currentDisc.vx * nx + currentDisc.vy * ny;
          currentDisc.vx -= 2.2 * dot * nx;
          currentDisc.vy -= 2.2 * dot * ny;
          
          currentDisc.vx += (Math.random() - 0.5) * 3.5;
          currentDisc.vy += (Math.random() - 0.5) * 3.5;
          currentDisc.vy = Math.max(currentDisc.vy, 0.8);
        }
      });
      
      if (currentDisc.y + DISC_RADIUS > BOARD_HEIGHT - 50) {
        const slotIndex = Math.floor(currentDisc.x / (BOARD_WIDTH / NUM_SLOTS));
        const winnings = SLOT_VALUES[slotIndex] || 0;
        gameState.totalScore += winnings;
        document.getElementById('totalScore').textContent = `Total Winnings: $${gameState.totalScore}`;
        currentDisc = null;
        saveGameState();
        drawBoard();
        cancelAnimationFrame(animationFrameId);
        return;
      }
      
      drawBoard();
      animationFrameId = requestAnimationFrame(animateDisc);
    }

    function handleCanvasClick(e) {
      if (currentDisc || selectedDiscIndex === -1) return;
      
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      if (y <= DROP_ZONE_Y_MAX && x >= DISC_RADIUS && x <= BOARD_WIDTH - DISC_RADIUS) {
        gameState.discs[selectedDiscIndex].used = true;
        currentDisc = {
          x: x,
          y: y,
          vx: (Math.random() - 0.5) * 2,
          vy: 0
        };
        selectedDiscIndex = -1;
        updateDiscList();
        saveGameState();
        animateDisc();
      }
    }

    function selectDisc(index) {
      if (currentDisc || gameState.discs[index].used) return;
      selectedDiscIndex = index;
      updateDiscList();
    }

    function getOrCreatePlayerId() {
      let id = localStorage.getItem('uslPlinkoPlayerId');
      if (!id) {
        id = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('uslPlinkoPlayerId', id);
      }
      return id;
    }

    async function loadGameState() {
      playerId = getOrCreatePlayerId();
      const gameRef = ref(database, 'plinkoGames/' + playerId);
      const snapshot = await get(gameRef);
      if (snapshot.exists()) {
        gameState = snapshot.val();
      }
    }

    async function saveGameState() {
      if (!playerId) return;
      await set(ref(database, 'plinkoGames/' + playerId), gameState);
    }

    function showPlayerInfo() {
      const playerInfo = document.getElementById('playerInfo');
      const availCount = gameState.discs.filter(d => !d.used).length;
      playerInfo.innerHTML = `Welcome, ${gameState.playerName}! ðŸŽ¯ Discs Available: ${availCount}`;
      playerInfo.style.display = 'block';
    }

    function updateDiscList() {
      const list = document.getElementById('availableDiscList');
      list.innerHTML = '';
      const available = gameState.discs.filter((d, i) => !d.used);
      
      gameState.discs.forEach((disc, index) => {
        if (disc.used) return;
        const item = document.createElement('div');
        item.className = 'disc-item' + (selectedDiscIndex === index ? ' selected' : '');
        item.onclick = () => selectDisc(index);
        item.innerHTML = `ðŸŽ¯ Disc #${index + 1}`;
        list.appendChild(item);
      });
      
      document.getElementById('availableCount').textContent = `(${available.length})`;
      if (gameState.playerName) {
        showPlayerInfo();
      }
    }

    function openEarnDiscModal() {
      document.getElementById('earnDiscModal').style.display = 'block';
      document.getElementById('activitySelect').value = '';
      document.getElementById('memberIdInput').value = '';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function closeEarnModal() {
      document.getElementById('earnDiscModal').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function validateMemberId(memberId) {
      const regex = /^[A-Z]{2,3}\d+$/;
      return memberId.length >= 5 && memberId.length <= 10 && regex.test(memberId);
    }

    async function submitEarnDisc() {
      console.log('submitEarnDisc called');
      const activity = document.getElementById('activitySelect').value;
      const memberId = document.getElementById('memberIdInput').value.trim().toUpperCase();
      const errorMsg = document.getElementById('errorMessage');

      console.log('Activity:', activity, 'Member ID:', memberId);

      if (!activity) {
        errorMsg.textContent = 'Please select an activity';
        errorMsg.style.display = 'block';
        return;
      }

      if (!validateMemberId(memberId)) {
        errorMsg.textContent = 'Invalid Member ID. Must be 2-3 letters followed by numbers (5-10 characters total)';
        errorMsg.style.display = 'block';
        return;
      }

      gameState.discs.push({ activity, memberId, used: false });
      console.log('Disc added to gameState:', gameState.discs);
      closeEarnModal();
      updateDiscList();
      await saveGameState();
      console.log('Game state saved');
    }

    function submitName() {
      const name = document.getElementById('nameInput').value.trim();
      const errorElement = document.getElementById('nameError');
      if (!name) {
        errorElement.style.display = 'block';
        return;
      }
      gameState.playerName = name;
      document.getElementById('nameModal').style.display = 'none';
      showPlayerInfo();
      saveGameState();
    }

    function clearProgress() {
      if (confirm('Clear all discs and score? This cannot be undone.')) {
        gameState.discs = [];
        gameState.totalScore = 0;
        updateDiscList();
        document.getElementById('totalScore').textContent = 'Total Winnings: $0';
        saveGameState();
      }
    }

    window.onload = async function() {
      console.log('Page loaded, initializing...');
      await loadGameState();
      initPlinkoBoard();
      updateDiscList();
      
      if (!gameState.playerName) {
        document.getElementById('nameModal').style.display = 'block';
      } else {
        showPlayerInfo();
      }

      // All event listeners
      document.getElementById('earnDiscBtn').addEventListener('click', openEarnDiscModal);
      document.getElementById('earnMoreBtn').addEventListener('click', openEarnDiscModal);
      document.getElementById('clearProgressBtn').addEventListener('click', clearProgress);
      document.getElementById('submitDiscBtn').addEventListener('click', function(e) {
        console.log('Submit button clicked');
        e.preventDefault();
        submitEarnDisc();
      });
      document.getElementById('cancelDiscBtn').addEventListener('click', closeEarnModal);
      document.getElementById('submitNameBtn').addEventListener('click', submitName);

      document.getElementById('nameInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          submitName();
        }
      });
      
      document.getElementById('memberIdInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          submitEarnDisc();
        }
      });
      
      document.getElementById('memberIdInput').addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
      });
      
      document.getElementById('totalScore').textContent = `Total Winnings: $${gameState.totalScore}`;
      console.log('All event listeners attached');
    };
  </script>
</body>
</html>
